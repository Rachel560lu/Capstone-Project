# place.py 实现逻辑总结

## 📋 系统概述

`place.py` 是一个基于 AI 的智能家具布置系统，使用 GPT-4o 视觉模型分析房间布局，并自动将家具合成到房间图片中。

---

## 🔄 核心工作流程

### 主流程（`place_furniture` 函数）

```
输入：家具选择 DataFrame + 房间背景图片
  ↓
1. 家具图片预处理（背景移除）
  ↓
2. AI 布局分析（GPT-4o）
  ↓
3. 生成家具视角图像（3D 视图生成）
  ↓
4. 图像合成（将家具放置到房间）
  ↓
输出：合成后的房间图片 + 布局结果 JSON
```

---

## 🧩 主要功能模块

### 1. **图像预处理模块**

#### 1.1 背景移除 (`remove_background_to_rgba`)
- **技术**：使用 `rembg` 库进行自动背景移除
- **功能**：
  - 将家具图片转换为 RGBA 格式（带透明通道）
  - 自动裁剪到内容边缘，去除多余透明区域
- **输出**：保存到 `outputs/rgba/` 目录

#### 1.2 图像工具函数
- `encode_image_to_base64`: 将图片编码为 base64（用于 GPT-4o API）
- `get_image_dimensions`: 获取图片像素尺寸
- `crop_to_content`: 裁剪图片到内容边缘

#### 1.3 深度图/法线图生成（已注释，可选功能）
- `generate_depth_map`: 使用 MiDaS 模型生成房间深度图
- `generate_normal_map_from_depth`: 从深度图生成法线图
- **用途**：帮助 AI 理解房间的 3D 结构（当前版本未启用）

---

### 2. **数据结构定义（Pydantic Models）**

#### 2.1 `Position`
- 家具在房间中的位置（归一化坐标 0.0-1.0）
- `x`: 水平位置（0.0=左边缘，1.0=右边缘）
- `y`: 垂直位置（0.0=上边缘，1.0=下边缘）

#### 2.2 `Rotation`
- 家具的旋转角度（用于 3D 视图生成）
- `azimuth_deg`: 水平旋转角度（-180° 到 180°）
- `elevation_deg`: 垂直倾斜角度（-90° 到 90°）

#### 2.3 `FurnitureLayout`
- 单个家具的完整布局参数
- `furniture_name`: 家具名称
- `position`: 位置坐标
- `rotation`: 旋转角度
- `scale`: 缩放因子（基于像素尺寸）
- `confidence`: 布局置信度（0.0-1.0）
- `model_id`: 家具模型 ID

#### 2.4 `LayoutResults`
- 所有家具的布局结果
- `furniture_list`: 家具布局列表
- `layout_reasoning`: 详细的布局推理说明

---

### 3. **AI 布局分析模块 (`analyze_room_layout`)**

#### 3.1 提示词构建 (`build_prompt`)
- **角色定义**：将 GPT-4o 定义为专业的空间布局设计师
- **输入信息**：
  - 房间图片
  - 每个家具的详细信息（类别、风格、尺寸、占地面积等）
  - 家具图片的像素尺寸
- **布局规则**：
  - 考虑家具完整边界，不只是中心点
  - 家具必须完全显示在房间内
  - 家具应贴合地板，不遮挡墙壁/窗户
  - 考虑房间建筑特征（窗户、门等）
- **输出格式**：详细说明每个家具的位置、旋转、缩放理由

#### 3.2 GPT-4o 调用流程
1. **准备输入**：
   - 房间背景图片（base64 编码）
   - 每个家具的图片（base64 编码）+ 标签信息
   - 系统提示词（包含家具信息和布局规则）

2. **模型调用**：
   - 使用 `ChatOpenAI` (GPT-4o) 模型
   - 使用 `with_structured_output` 确保返回 Pydantic 格式
   - Temperature = 0.2（保证输出稳定性）

3. **输出解析**：
   - 自动解析为 `LayoutResults` 结构
   - 包含每个家具的布局参数和详细推理说明

---

### 4. **3D 视图生成模块 (`generate_furniture_view`)**

#### 4.1 功能
- 根据指定的方位角（azimuth）和仰角（elevation）生成家具的新视角图像
- 使用 Stable Diffusion 模型（TurnCam）进行 3D 视图生成

#### 4.2 技术细节
- **模型加载**：使用缓存机制避免重复加载
- **预处理**：使用 CarveKit 进行背景移除
- **生成参数**：
  - DDIM 采样器
  - 256×256 输出分辨率
  - 75 步推理
  - Guidance scale = 3.0

#### 4.3 优化
- 如果角度接近 0°，直接使用原图（避免不必要的生成）
- 生成失败时回退到原图

---

### 5. **图像合成模块 (`compose_room_with_furniture`)**

#### 5.1 合成流程
1. **读取房间背景图片**
2. **遍历每个家具**：
   - 根据布局结果生成对应视角的家具图像
   - 根据 `scale` 参数调整家具大小
   - 根据 `position` 参数计算放置位置
3. **Alpha 混合**：
   - 使用透明通道进行自然融合
   - 处理边界裁剪（家具超出房间边界的情况）

#### 5.2 坐标转换
- 归一化坐标 (0.0-1.0) → 像素坐标
- 计算家具中心点位置
- 处理边界情况（家具部分超出房间）

#### 5.3 输出
- 返回合成后的房间图片（numpy 数组）
- 保存为 `outputs/composed_room.jpg`

---

## 📊 数据流图

```
家具选择 DataFrame
  ↓
[预处理] 背景移除 → RGBA 图片
  ↓
[AI 分析] GPT-4o 视觉模型
  ├─ 输入：房间图片 + 家具图片 + 家具信息
  └─ 输出：布局参数（位置、旋转、缩放）
  ↓
[视图生成] 3D 视图生成模型（可选）
  └─ 根据旋转角度生成新视角
  ↓
[图像合成] Alpha 混合
  └─ 将家具合成到房间图片
  ↓
最终合成图片
```

---

## 🔑 关键技术点

### 1. **结构化输出**
- 使用 LangChain + Pydantic 确保 AI 输出格式正确
- 自动验证数据类型和范围

### 2. **多模态输入**
- GPT-4o 同时处理文本提示和图像输入
- 支持多张图片输入（房间 + 多个家具）

### 3. **智能布局推理**
- AI 考虑房间结构、家具关系、功能需求
- 提供详细的布局推理说明（可解释性）

### 4. **3D 视图生成**
- 根据布局需求动态生成家具视角
- 模型缓存优化性能

### 5. **图像处理**
- Alpha 通道混合实现自然合成
- 边界处理确保家具不超出房间

---

## 📁 输出文件

1. **`outputs/rgba/{model_id}.png`**
   - 去背景后的家具图片（RGBA 格式）

2. **`outputs/layout_results.json`**
   - 布局分析结果（包含所有家具的位置、旋转、缩放参数）
   - 详细的布局推理说明

3. **`outputs/composed_room.jpg`**
   - 最终合成后的房间图片

---

## 🎯 系统特点

### ✅ 优势
1. **智能化**：使用 GPT-4o 进行专业级布局分析
2. **自动化**：端到端自动化流程，无需人工干预
3. **可解释性**：提供详细的布局推理说明
4. **灵活性**：支持任意数量的家具和房间类型
5. **3D 感知**：支持生成不同视角的家具视图

### ⚠️ 注意事项
1. 需要 GPU 支持 3D 视图生成（可选功能）
2. 依赖 OpenAI API（需要 API Key）
3. 深度图/法线图功能当前已注释（可选增强）

---

## 🔧 依赖项

- **AI 模型**：GPT-4o (OpenAI)
- **图像处理**：OpenCV, PIL, rembg
- **3D 视图生成**：Stable Diffusion (TurnCam)
- **数据处理**：Pandas, NumPy
- **结构化输出**：LangChain, Pydantic

---

## 📝 使用示例

```python
# 主函数调用
place_furniture(
    selection_df=selected_furniture_df,  # 包含家具信息的 DataFrame
    room_image_path="data/empty_room.jpg"  # 房间背景图片
)
```

系统会自动完成：
1. 家具图片预处理
2. AI 布局分析
3. 图像合成
4. 结果保存



